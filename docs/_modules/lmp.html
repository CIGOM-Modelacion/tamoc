<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>lmp &mdash; Texas A&amp;M Oilspill Calculator v0.1 Manual</title>
    
    <link rel="stylesheet" href="../_static/scipy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1.11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Texas A&amp;M Oilspill Calculator v0.1 Manual" href="../contents.html" />
    <link rel="up" title="Module code" href="index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
<li><a href="../index.html">Texas A&M Oilspill Calculator v0.1 Manual</a> &raquo;</li>

          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for lmp</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Lagrangian Multiphase Plume</span>
<span class="sd">===========================</span>

<span class="sd">This module contains the numerical solution for the `bent_plume_model` module.</span>
<span class="sd">Some of the general tools for handling the multiphase components are</span>
<span class="sd">contained in `dispersed_phases`.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># S. Socolofsky, November 2014, Texas A&amp;M University &lt;socolofs@tamu.edu&gt;.</span>
<span class="kn">from</span> <span class="nn">tamoc</span> <span class="kn">import</span> <span class="n">seawater</span>
<span class="kn">from</span> <span class="nn">tamoc</span> <span class="kn">import</span> <span class="n">dispersed_phases</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>

<div class="viewcode-block" id="derivs"><a class="viewcode-back" href="../bpm/lmp.derivs.html#lmp.derivs">[docs]</a><span class="k">def</span> <span class="nf">derivs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">dtp_ds</span><span class="p">,</span> <span class="n">q0_local</span><span class="p">,</span> <span class="n">q1_local</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">particles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the derivatives for the system of ODEs for a Lagrangian plume</span>
<span class="sd">    </span>
<span class="sd">    Calculates the right-hand-side of the system of ODEs for a Lagrangian </span>
<span class="sd">    plume integral model.  The continuous phase model matches very closely </span>
<span class="sd">    the model of Lee and Cheung (1990).  Multiphase extensions following the</span>
<span class="sd">    strategy in Socolofsky et al. (2008) with adaptation to Lagrangian plume</span>
<span class="sd">    models by Johansen (2000, 2003) and Yapa and Zheng (1997).  This function</span>
<span class="sd">    solves for the entire state space except for the dispersed phase particle</span>
<span class="sd">    tracking.  Particle tracking is handled by an analytical solution </span>
<span class="sd">    between each numerical time step; the tracking equations are in the </span>
<span class="sd">    `bent_plume_model.Particle.track` method.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t : float</span>
<span class="sd">        Current value for the independent variable (time in m).</span>
<span class="sd">    q : ndarray</span>
<span class="sd">        Current value for the plume state space vector.</span>
<span class="sd">    q0_local : `bent_plume_model.LagElement`</span>
<span class="sd">        Object containing the numerical solution at the previous time step</span>
<span class="sd">    q1_local : `bent_plume_model.LagElement`</span>
<span class="sd">        Object containing the numerical solution at the current time step</span>
<span class="sd">    profile : `ambient.Profile` object</span>
<span class="sd">        The ambient CTD object used by the simulation.</span>
<span class="sd">    p : `ModelParams` object</span>
<span class="sd">        Object containing the fixed model parameters for the bent</span>
<span class="sd">        plume model.</span>
<span class="sd">    particles : list of `Particle` objects</span>
<span class="sd">        List of `bent_plume_model.Particle` objects containing the dispersed </span>
<span class="sd">        phase local conditions and behavior.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    yp : ndarray</span>
<span class="sd">        A vector of the derivatives of the plume state space.</span>
<span class="sd">    </span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    calculate</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Set up the output from the function to have the right size and shape</span>
    <span class="n">qp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    
    <span class="c"># Update the local Lagrangian element properties</span>
    <span class="n">q1_local</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">particles</span><span class="p">)</span>
    
    <span class="c"># Get the entrainment flux</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">entrainment</span><span class="p">(</span><span class="n">q0_local</span><span class="p">,</span> <span class="n">q1_local</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    
    <span class="c"># Conservation of Mass</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span>
    
    <span class="c"># Conservation of salt and heat</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">Sa</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span> <span class="o">*</span> <span class="n">seawater</span><span class="o">.</span><span class="n">cp</span><span class="p">()</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">Ta</span>
    
    <span class="c"># Conservation of continuous phase momentum.  Note that z is positive</span>
    <span class="c"># down (depth).</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">ua</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">g</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">rho_r</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">Fb</span> <span class="o">+</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">M</span> <span class="o">*</span> 
            <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">rho_a</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">rho</span><span class="p">))</span>
    
    <span class="c"># Constant h/V thickeness to velocity ratio</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    
    <span class="c"># Lagrangian plume element advection (x, y, z) and s along the centerline</span>
    <span class="c"># trajectory</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">u</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">v</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">w</span>
    <span class="n">qp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">V</span>
    
    <span class="c"># Conservation equations for each dispersed phase</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">11</span>
    
    <span class="c"># Track the mass dissolving into the continuous phase</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">nchems</span><span class="p">)</span>
    
    <span class="c"># Compute mass and heat transfer for each particle</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">np</span><span class="p">):</span>
        
        <span class="c"># Track each particle&#39;s mass transfer separately</span>
        <span class="n">dm_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">nchems</span><span class="p">)</span>
        
        <span class="c"># Realize that the travel time for the particle is different from </span>
        <span class="c"># that of the plume.  Compute the time adjustment.</span>
        <span class="k">if</span> <span class="n">dtp_ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">dtp_ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">V</span>
        
        <span class="c"># Dissolution</span>
        <span class="k">if</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">issoluble</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">nchems</span><span class="p">):</span>
                
                <span class="c"># Conservation of particle mass for a single chemical j</span>
                <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">A</span> <span class="o">*</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nb0</span> <span class="o">*</span> \
                          <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Cs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> 
                          <span class="n">q1_local</span><span class="o">.</span><span class="n">c_chems</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">dtp_ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">V</span>
                <span class="n">dm_p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                
                <span class="c"># Update continuous phase temperature with heat of solution</span>
                <span class="n">qp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">neg_dH_solR</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">Ru</span> <span class="o">/</span> \
                         <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Non-dissolving particles have one component</span>
            <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c"># Update the total mass dissolved</span>
        <span class="n">dm</span> <span class="o">+=</span> <span class="n">dm_p</span>
        
        <span class="c"># Heat transfer between the particle and the ambient</span>
        <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">A</span> <span class="o">*</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nb0</span> <span class="o">*</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rho_p</span> <span class="o">*</span> \
                  <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cp</span> <span class="o">*</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">beta_T</span> <span class="o">*</span> <span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> 
                  <span class="n">q1_local</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtp_ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">V</span>
        
        <span class="c"># Heat loss due to mass loss by dissolution</span>
        <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dm_p</span><span class="p">)</span> <span class="o">*</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cp</span> <span class="o">*</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        
        <span class="c"># Take the heat leaving the particle and put it in the continuous </span>
        <span class="c"># phase fluid</span>
        <span class="n">qp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c"># Conservation equations for the dissolved constituents in the plume</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">nchems</span><span class="p">):</span>
        <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">ca_chems</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">dm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    
    <span class="c"># Conservation equation for the passive tracers in the plume</span>
    <span class="n">qp</span><span class="p">[</span><span class="n">idx</span><span class="p">:]</span> <span class="o">=</span> <span class="n">md</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">ca_tracers</span>
    
    <span class="c"># Return the slopes</span>
    <span class="k">return</span> <span class="n">qp</span>

</div>
<div class="viewcode-block" id="calculate"><a class="viewcode-back" href="../bpm/lmp.calculate.html#lmp.calculate">[docs]</a><span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">q0_local</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">derivs</span><span class="p">,</span> 
    <span class="n">dt_max</span><span class="p">,</span> <span class="n">sd_max</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate an the Lagrangian plume solution</span>
<span class="sd">    </span>
<span class="sd">    Compute the solution tracking along the centerline of the plume until </span>
<span class="sd">    the plume reaches the water surface, reaches a neutral buoyancy level </span>
<span class="sd">    within the intrusion layer, or propagates a given maximum number of</span>
<span class="sd">    nozzle diameters downstream.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    t0 : float</span>
<span class="sd">        Initial time (s)</span>
<span class="sd">    q0 : ndarray</span>
<span class="sd">        Initial values of the state space vector</span>
<span class="sd">    q0_local : `bent_plume_model.LagElement`</span>
<span class="sd">        Object containing the numerical solution at the initial condition</span>
<span class="sd">    profile : `ambient.Profile` object</span>
<span class="sd">        The ambient CTD object used by the simulation.</span>
<span class="sd">    p : `ModelParams` object</span>
<span class="sd">        Object containing the fixed model parameters for the bent</span>
<span class="sd">        plume model.</span>
<span class="sd">    particles : list of `Particle` objects</span>
<span class="sd">        List of `bent_plume_model.Particle` objects containing the dispersed </span>
<span class="sd">        phase local conditions and behavior.</span>
<span class="sd">    derivs : function handle</span>
<span class="sd">        Pointer to the function where the derivatives of the ODE system are</span>
<span class="sd">        stored.  Should be `lmp.derivs`.</span>
<span class="sd">    dt_max : float</span>
<span class="sd">        Maximum step size to use in the simulation (s).  The ODE solver </span>
<span class="sd">        in `calculate` is set up with adaptive step size integration, so </span>
<span class="sd">        this value determines the largest step size in the output data, but </span>
<span class="sd">        not the numerical stability of the calculation.</span>
<span class="sd">    sd_max : float</span>
<span class="sd">        Maximum number of nozzle diameters to compute along the plume </span>
<span class="sd">        centerline (s/D)_max.  This is the only stop criteria that is user-</span>
<span class="sd">        selectable.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : ndarray</span>
<span class="sd">        Vector of times when the plume solution is obtained (s).</span>
<span class="sd">    y : ndarray</span>
<span class="sd">        Matrix of the plume state space solutions.  Each row corresponds to</span>
<span class="sd">        a time in `t`.</span>
<span class="sd">    sp : ndarray</span>
<span class="sd">        Matrix of the positions of all the particles in `particles`.  Each</span>
<span class="sd">        row corresponds to a time in `t`.  Each particle has three columns</span>
<span class="sd">        in `sp`, one each for (x, y, z) position.  When the particle reaches</span>
<span class="sd">        the edge of the plume, it is no longer tracked; hence, its position</span>
<span class="sd">        remains constant for the remainder of the plume integration.</span>
<span class="sd">    </span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    derivs, bent_plume_mode.Model</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Create an integrator object:  use &quot;vode&quot; with &quot;backward </span>
    <span class="c"># differentitaion formula&quot; for stiff ODEs</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">ode</span><span class="p">(</span><span class="n">derivs</span><span class="p">)</span><span class="o">.</span><span class="n">set_integrator</span><span class="p">(</span><span class="s">&#39;vode&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&#39;bdf&#39;</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span>
        <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="n">dt_max</span><span class="p">)</span>
    
    <span class="c"># Push the initial state space to the integrator object</span>
    <span class="n">r</span><span class="o">.</span><span class="n">set_initial_value</span><span class="p">(</span><span class="n">q0</span><span class="p">,</span> <span class="n">t0</span><span class="p">)</span>
    
    <span class="c"># Make a copy of the q1_local object needed to evaluate the entrainment</span>
    <span class="n">q1_local</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">q0_local</span><span class="p">)</span>
    <span class="n">q0_hold</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">q1_local</span><span class="p">)</span>
    
    <span class="c"># Create vectors (using the list data type) to store the solution</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">t0</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">q0</span><span class="p">]</span>
    <span class="n">xpi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tpi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)):</span>
        <span class="n">xpi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">xpi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="n">xpi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="n">tpi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="p">[</span><span class="n">xpi</span><span class="p">]</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="p">[</span><span class="n">tpi</span><span class="p">]</span>
    <span class="n">dtp_ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">))</span>
    
    <span class="c"># Integrate a finite number of time steps</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">psteps</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">while</span> <span class="n">r</span><span class="o">.</span><span class="n">successful</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>
        
        <span class="c"># Print progress to the screen</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">psteps</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;    Distance:  </span><span class="si">%g</span><span class="s"> (m), time:  </span><span class="si">%g</span><span class="s"> (s), k:  </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
        
        <span class="c"># Perform one step of the integration</span>
        <span class="n">r</span><span class="o">.</span><span class="n">set_f_params</span><span class="p">(</span><span class="n">dtp_ds</span><span class="p">,</span> <span class="n">q0_local</span><span class="p">,</span> <span class="n">q1_local</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">particles</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt_max</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        
        <span class="c"># Store the results</span>
        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c"># Update the Lagrangian elements</span>
        <span class="n">q0_local</span> <span class="o">=</span> <span class="n">q0_hold</span>
        <span class="n">q1_local</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">profile</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">particles</span><span class="p">)</span>
        <span class="n">q0_hold</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">q1_local</span><span class="p">)</span>
        
        <span class="c"># Find the displacement</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">s</span>
        
        <span class="c"># Track the dispersed phase particles</span>
        <span class="n">xpi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tpi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)):</span>
            
            <span class="c"># Track the particles through this Lagrangian element</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">entrainment</span><span class="p">(</span><span class="n">q0_local</span><span class="p">,</span> <span class="n">q1_local</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="n">q0_local</span><span class="p">,</span> <span class="n">q1_local</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="c"># Store the particle positions</span>
            <span class="n">xpi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">xpi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">xpi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="n">tpi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
                
            <span class="c"># Get the differential particle time step</span>
            <span class="n">dtp_ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tpi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">tp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">ds</span>
        
        <span class="c"># Record the particle positions for this timestep</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xpi</span><span class="p">)</span>
        <span class="n">tp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tpi</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c"># Evaluate the stop criteria</span>
        <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">/</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">D</span> <span class="o">&gt;</span> <span class="n">sd_max</span><span class="p">:</span>
            <span class="c"># Progressed far along the plume centerline</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">:</span>
            <span class="c"># Stop after specified number of iterations</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="c"># Reached a location above the free surface</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">10</span><span class="p">]:</span>
            <span class="c"># Progress of motion of the plume has stopped</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">True</span>
    
    <span class="c"># Convert solution to numpy arrays</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
    
    <span class="c"># Show user the final calculated point and return the solution</span>
    <span class="k">print</span> <span class="s">&#39;    Distance:  </span><span class="si">%g</span><span class="s"> (m), time:  </span><span class="si">%g</span><span class="s"> (s), k:  </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="entrainment"><a class="viewcode-back" href="../bpm/lmp.entrainment.html#lmp.entrainment">[docs]</a><span class="k">def</span> <span class="nf">entrainment</span><span class="p">(</span><span class="n">q0_local</span><span class="p">,</span> <span class="n">q1_local</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the total shear and forced entrainment at one time step</span>
<span class="sd">    </span>
<span class="sd">    Computes the local entrainment (kg/s) as a combination of shear </span>
<span class="sd">    entrainment and forced entrainment for a local Lagrangian element.  This</span>
<span class="sd">    function follows the equations in Lee and Cheung (1990) to compute both</span>
<span class="sd">    types of entrainment.  It also uses the maximum entrainment hypothesis:</span>
<span class="sd">    entrainment = max (shear, forced), with the exception that a pure </span>
<span class="sd">    coflowing momentum jet has entrainment = shear + forced.  This function</span>
<span class="sd">    also makes one the correction that in pure coflow the force entrainment</span>
<span class="sd">    should be computed by integrating around the entire jet, and not just </span>
<span class="sd">    the half of the jet exposed to the current.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q0_local : `bent_plume_model.LagElement`</span>
<span class="sd">        Object containing the numerical solution at the previous time step</span>
<span class="sd">    q1_local : `bent_plume_model.LagElement`</span>
<span class="sd">        Object containing the numerical solution at the current time step</span>
<span class="sd">    p : `ModelParams` object</span>
<span class="sd">        Object containing the fixed model parameters for the bent</span>
<span class="sd">        plume model.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    md : float</span>
<span class="sd">        Total entrainment (kg/s)</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The entrainment computed here is already integrated over the current </span>
<span class="sd">    Lagrangian element surface area.  Hence, the result is (kg/s) into the </span>
<span class="sd">    element.  </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Gaussian model jet entrainment coefficient</span>
    <span class="n">alpha_j</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">alpha_1</span>
    
    <span class="c"># Gaussian model plume entrainment coefficient</span>
    <span class="k">if</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">rho_a</span> <span class="o">==</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">rho</span><span class="p">:</span>
        <span class="c"># This is a pure jet</span>
        <span class="n">alpha_p</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># This is a plume; compute the densimetric Gaussian Froude number</span>
        <span class="n">F1</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">V</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">ua</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">rho_a</span> <span class="o">-</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">1.2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.2</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">rho_a</span> <span class="o">*</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">b</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
        
        <span class="c"># Follow Figure 13 in Jirka (2004)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">F1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">alpha_2</span> <span class="o">/</span> <span class="mf">0.028</span><span class="p">:</span>
            <span class="n">alpha_p</span> <span class="o">=</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">rho_a</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">alpha_2</span> <span class="o">*</span> \
                      <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span> <span class="o">/</span> <span class="n">F1</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_p</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.083</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">alpha_1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">alpha_2</span> <span class="o">/</span> <span class="mf">0.028</span><span class="p">)</span> <span class="o">*</span> <span class="n">F1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> \
                      <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">rho_a</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>
        
    <span class="c"># Compute the total shear entrainment coefficient for the top-hat model</span>
    <span class="n">alpha_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">alpha_j</span> <span class="o">+</span> <span class="n">alpha_p</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">V</span> <span class="o">/</span> \
              <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">V</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">ua</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> 
              <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
    
    <span class="c"># Total shear entrainment (kg/s)</span>
    <span class="n">md_s</span> <span class="o">=</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">rho_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">V</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">ua</span> <span class="o">*</span> 
           <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha_s</span> <span class="o">*</span> <span class="p">(</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> 
           <span class="n">q1_local</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
         
    <span class="c"># Compute the projected area entrainment terms...first, the crossflow </span>
    <span class="c"># projected onto the plume centerline</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> 
         <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">h</span>
    <span class="k">if</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">s</span> <span class="o">==</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">s</span><span class="p">:</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Second, correction for plume expansion</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">b</span> <span class="o">-</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">s</span> <span class="o">-</span> 
             <span class="n">q0_local</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span>
        <span class="c"># Third, correction for plume curvature</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span> <span class="o">-</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">cos_t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">s</span> 
             <span class="o">-</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">h</span>
    
    <span class="c"># Get the total projected area for the forced entraiment</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.e-9</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.e-9</span><span class="p">:</span>
        <span class="c"># Jet is in co-flow, shear entrainment model takes care of this case</span>
        <span class="c"># by itself</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Compute the regular forced entrainment model</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span> <span class="o">+</span> <span class="n">a3</span>
    
    <span class="c"># Total forced entrainment (kg/s)</span>
    <span class="n">md_f</span> <span class="o">=</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">rho_a</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">ua</span> <span class="o">*</span> <span class="n">A</span>
    
    <span class="c"># Obtain the total entrainment using the maximum hypothesis from Lee and </span>
    <span class="c"># Cheung (1990)</span>
    <span class="k">if</span> <span class="n">md_s</span> <span class="o">&gt;</span> <span class="n">md_f</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md_s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md_f</span>
    
    <span class="c"># Return the entrainment rate</span>
    <span class="k">return</span> <span class="n">md</span>

</div>
<div class="viewcode-block" id="local_coords"><a class="viewcode-back" href="../bpm/lmp.local_coords.html#lmp.local_coords">[docs]</a><span class="k">def</span> <span class="nf">local_coords</span><span class="p">(</span><span class="n">q0_local</span><span class="p">,</span> <span class="n">q1_local</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the rotation matrix from (x, y, z)&#39; to (l, n, m)</span>
<span class="sd">    </span>
<span class="sd">    Computes the rotation matrix from the local Cartesian coordinate system</span>
<span class="sd">    (x - xi, y - yi, z - zi), where (xi, yi, zi) is the current location of</span>
<span class="sd">    the Lagrangian plume element, to the system tangent to the current plume</span>
<span class="sd">    trajectory (l, n, m); l is oriented tangent to the plume centerline, </span>
<span class="sd">    n is orthogonal to l and along the line from the local radius of </span>
<span class="sd">    curvature, and m is orthogonal to n and l.  The transformation is </span>
<span class="sd">    provided in Lee and Chueng (1990).  This method makes a small adaptation</span>
<span class="sd">    allowing for infinite radius of curvature (plume propagating along a </span>
<span class="sd">    straight line).  </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q0_local : `bent_plume_model.LagElement`</span>
<span class="sd">        Object containing the numerical solution at the previous time step</span>
<span class="sd">    q1_local : `bent_plume_model.LagElement`</span>
<span class="sd">        Object containing the numerical solution at the current time step</span>
<span class="sd">    ds : float</span>
<span class="sd">        Segment length along the centerline between the solutions contained </span>
<span class="sd">        in `q0_local` and `q1_local`.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A : ndarray</span>
<span class="sd">        Rotation matrix from (x, y, z)&#39; to (l, n, m).  The inverse of this</span>
<span class="sd">        matrix will convert back from (l, n, m) to (x, y, z)&#39;.</span>
<span class="sd">    </span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    bent_plume_model.Particle.track</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get the rate of angular rotation for the centerline</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="o">&lt;</span> <span class="mf">1.e-12</span><span class="p">:</span>
        <span class="n">phi_d</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">theta_d</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phi_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">phi</span> <span class="o">-</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">phi</span><span class="p">)</span> <span class="o">/</span> <span class="n">ds</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">theta</span> <span class="o">-</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
            <span class="c"># Angles are close to 0</span>
            <span class="k">if</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">theta</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="n">theta_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">theta</span> <span class="o">-</span> <span class="p">(</span><span class="n">q0_local</span><span class="o">.</span><span class="n">theta</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">/</span> <span class="n">ds</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">theta</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="n">ds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theta_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">q1_local</span><span class="o">.</span><span class="n">theta</span> <span class="o">-</span> <span class="n">q0_local</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="o">/</span> <span class="n">ds</span>
    
    <span class="c"># Get the value of 1 / R = r</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi_d</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">theta_d</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c"># Compute the rotation matrix between (i,j,k) and (l,n,m)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mf">1.e-8</span><span class="p">:</span>
        <span class="c"># Trajectory is straight and R is infinite</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span><span class="p">,</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span><span class="p">,</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span><span class="p">],</span> 
            <span class="p">[</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span><span class="p">,</span>
             <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span><span class="p">,</span>
             <span class="o">-</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span><span class="p">],</span> 
            <span class="p">[</span><span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span><span class="p">,</span>
             <span class="o">-</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span><span class="p">,</span>
             <span class="mf">0.</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Trajectory is curving, and R is finite</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span><span class="p">,</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span><span class="p">,</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span><span class="p">],</span> 
            <span class="p">[</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span> <span class="o">*</span> <span class="n">theta_d</span> <span class="o">+</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span> <span class="o">*</span> 
                <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span> <span class="o">*</span> <span class="n">phi_d</span><span class="p">,</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span> <span class="o">*</span> <span class="n">phi_d</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> 
                <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span> <span class="o">*</span> <span class="n">theta_d</span><span class="p">,</span> 
             <span class="o">-</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">phi_d</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">,</span> 
            <span class="p">[</span><span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span> <span class="o">*</span> <span class="n">phi_d</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> 
                <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span> <span class="o">*</span> <span class="n">theta_d</span><span class="p">,</span>
             <span class="o">-</span><span class="n">q1_local</span><span class="o">.</span><span class="n">cos_t</span> <span class="o">*</span> <span class="n">phi_d</span> <span class="o">-</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span> <span class="o">*</span> <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_t</span> <span class="o">*</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">sin_p</span> <span class="o">*</span> <span class="n">theta_d</span><span class="p">,</span> 
             <span class="n">q1_local</span><span class="o">.</span><span class="n">cos_p</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">theta_d</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">])</span>
    
    <span class="c"># Return the rotation matrix</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="c"># ----------------------------------------------------------------------------</span>
<span class="c"># Functions to compute the initial conditions for the first model element</span>
<span class="c"># ----------------------------------------------------------------------------</span>
</div>
<div class="viewcode-block" id="main_ic"><a class="viewcode-back" href="../bpm/lmp.main_ic.html#lmp.main_ic">[docs]</a><span class="k">def</span> <span class="nf">main_ic</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">Vj</span><span class="p">,</span> <span class="n">phi_0</span><span class="p">,</span> <span class="n">theta_0</span><span class="p">,</span> <span class="n">Sj</span><span class="p">,</span> <span class="n">Tj</span><span class="p">,</span> <span class="n">cj</span><span class="p">,</span> 
            <span class="n">tracers</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the initial conditions for the Lagrangian plume state space</span>
<span class="sd">    </span>
<span class="sd">    Compute the initial conditions at the release location for a Lagrangian</span>
<span class="sd">    plume element.  This can either be a pure single-phase plume, a pure</span>
<span class="sd">    multiphase plume, or a mixed release of multiphase and continuous phase</span>
<span class="sd">    fluid.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : `ambient.Profile` object</span>
<span class="sd">        The ambient CTD object used by the single bubble model simulation.</span>
<span class="sd">    particles : list of `Particle` objects</span>
<span class="sd">        List of `bent_plume_model.Particle` objects containing the dispersed </span>
<span class="sd">        phase local conditions and behavior.</span>
<span class="sd">    X : ndarray</span>
<span class="sd">        Release location (x, y, z) in (m)</span>
<span class="sd">    D : float</span>
<span class="sd">        Diameter for the equivalent circular cross-section of the release </span>
<span class="sd">        (m)</span>
<span class="sd">    Vj : float</span>
<span class="sd">        Scalar value of the magnitude of the discharge velocity for </span>
<span class="sd">        continuous phase fluid in the discharge.  This variable should be </span>
<span class="sd">        0 or None for a pure multiphase discharge.</span>
<span class="sd">    phi_0 : float</span>
<span class="sd">        Vertical angle from the horizontal for the discharge orientation </span>
<span class="sd">        (rad in range +/- pi/2)</span>
<span class="sd">    theta_0 : float</span>
<span class="sd">        Horizontal angle from the x-axis for the discharge orientation.  </span>
<span class="sd">        The x-axis is taken in the direction of the ambient current.  </span>
<span class="sd">        (rad in range 0 to 2 pi)</span>
<span class="sd">    Sj : float</span>
<span class="sd">        Salinity of the continuous phase fluid in the discharge (psu)</span>
<span class="sd">    Tj : float</span>
<span class="sd">        Temperature of the continuous phase fluid in the discharge (T)</span>
<span class="sd">    cj : ndarray</span>
<span class="sd">        Concentration of passive tracers in the discharge (user-defined)</span>
<span class="sd">    tracers : string list</span>
<span class="sd">        List of passive tracers in the discharge.  These can be chemicals </span>
<span class="sd">        present in the ambient `profile` data, and if so, entrainment of </span>
<span class="sd">        these chemicals will change the concentrations computed for these </span>
<span class="sd">        tracers.  However, none of these concentrations are used in the </span>
<span class="sd">        dissolution of the dispersed phase.  Hence, `tracers` should not </span>
<span class="sd">        contain any chemicals present in the dispersed phase particles.</span>
<span class="sd">    p : `stratified_plume_model.ModelParams` object</span>
<span class="sd">        Object containing the fixed model parameters for the stratified </span>
<span class="sd">        plume model.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : float</span>
<span class="sd">        Initial time for the simulation (s)</span>
<span class="sd">    q : ndarray</span>
<span class="sd">        Initial value of the plume state space</span>
<span class="sd">    chem_names : str list</span>
<span class="sd">        List of the chemicals in the dispersed phase composition that are </span>
<span class="sd">        undergoing dissolution</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get the initial volume flux</span>
    <span class="k">if</span> <span class="n">Vj</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">Vj</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="c"># This is a pure multiphase plume.  Estimate the initial conditions </span>
        <span class="c"># using Wuest et al. 1992.</span>
        <span class="n">Q</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Tj</span><span class="p">,</span> <span class="n">Sj</span><span class="p">,</span> <span class="n">Pj</span><span class="p">,</span> <span class="n">rho_j</span> <span class="o">=</span> <span class="n">dispersed_phases</span><span class="o">.</span><span class="n">zfe_volume_flux</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> 
            <span class="n">particles</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># The discharge contains continuous phase fluid.  Get the flow rate</span>
        <span class="c"># from the discharge conditions.</span>
        <span class="n">Q</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Tj</span><span class="p">,</span> <span class="n">Sj</span><span class="p">,</span> <span class="n">Pj</span><span class="p">,</span> <span class="n">rho_j</span> <span class="o">=</span> <span class="n">zfe_volume_flux</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">Vj</span><span class="p">,</span> 
                                     <span class="n">Sj</span><span class="p">,</span> <span class="n">Tj</span><span class="p">)</span>
    
    <span class="c"># Get the names of the chemicals to track</span>
    <span class="n">chem_names</span> <span class="o">=</span> <span class="n">dispersed_phases</span><span class="o">.</span><span class="n">get_chem_names</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
    
    <span class="c"># Build the initial state space with these initial values</span>
    <span class="n">t</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">bent_plume_ic</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">phi_0</span><span class="p">,</span> <span class="n">theta_0</span><span class="p">,</span> 
             <span class="n">Tj</span><span class="p">,</span> <span class="n">Sj</span><span class="p">,</span> <span class="n">Pj</span><span class="p">,</span> <span class="n">rho_j</span><span class="p">,</span> <span class="n">cj</span><span class="p">,</span> <span class="n">chem_names</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
    
    <span class="c"># Return the initial state space</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">chem_names</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="bent_plume_ic"><a class="viewcode-back" href="../bpm/lmp.bent_plume_ic.html#lmp.bent_plume_ic">[docs]</a><span class="k">def</span> <span class="nf">bent_plume_ic</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">Qj</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">phi_0</span><span class="p">,</span> <span class="n">theta_0</span><span class="p">,</span> <span class="n">Tj</span><span class="p">,</span> <span class="n">Sj</span><span class="p">,</span> 
                  <span class="n">Pj</span><span class="p">,</span> <span class="n">rho_j</span><span class="p">,</span> <span class="n">cj</span><span class="p">,</span> <span class="n">chem_names</span><span class="p">,</span> <span class="n">tracers</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build the Lagragian plume state space given the initial conditions</span>
<span class="sd">    </span>
<span class="sd">    Constructs the initial state space for a Lagrangian plume element from </span>
<span class="sd">    the initial values for the base plume variables (e.g., Q, J, u, S, T, </span>
<span class="sd">    etc.).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : `ambient.Profile` object</span>
<span class="sd">        The ambient CTD object used by the single bubble model simulation.</span>
<span class="sd">    particles : list of `Particle` objects</span>
<span class="sd">        List of `bent_plume_model.Particle` objects containing the dispersed </span>
<span class="sd">        phase local conditions and behavior.</span>
<span class="sd">    Qj : Volume flux of continuous phase fluid at the discharge (m^3/s)</span>
<span class="sd">    A : Cross-sectional area of the discharge (M^2)</span>
<span class="sd">    D : float</span>
<span class="sd">        Diameter for the equivalent circular cross-section of the release </span>
<span class="sd">        (m)</span>
<span class="sd">    X : ndarray</span>
<span class="sd">        Release location (x, y, z) in (m)</span>
<span class="sd">    phi_0 : float</span>
<span class="sd">        Vertical angle from the horizontal for the discharge orientation </span>
<span class="sd">        (rad in range +/- pi/2)</span>
<span class="sd">    theta_0 : float</span>
<span class="sd">        Horizontal angle from the x-axis for the discharge orientation.  </span>
<span class="sd">        The x-axis is taken in the direction of the ambient current.  </span>
<span class="sd">        (rad in range 0 to 2 pi)</span>
<span class="sd">    Tj : float</span>
<span class="sd">        Temperature of the continuous phase fluid in the discharge (T)</span>
<span class="sd">    Sj : float</span>
<span class="sd">        Salinity of the continuous phase fluid in the discharge (psu)</span>
<span class="sd">    Pj : float</span>
<span class="sd">        Pressure at the discharge (Pa)</span>
<span class="sd">    rho_j : float</span>
<span class="sd">        Density of the continous phase fluid in the discharge (kg/m^3)</span>
<span class="sd">    cj : ndarray</span>
<span class="sd">        Concentration of passive tracers in the discharge (user-defined)</span>
<span class="sd">    chem_names : string list</span>
<span class="sd">        List of chemical parameters to track for the dissolution.  Only the </span>
<span class="sd">        parameters in this list will be used to set background concentration</span>
<span class="sd">        for the dissolution, and the concentrations of these parameters are </span>
<span class="sd">        computed separately from those listed in `tracers` or inputed from</span>
<span class="sd">        the discharge through `cj`.</span>
<span class="sd">    tracers : string list</span>
<span class="sd">        List of passive tracers in the discharge.  These can be chemicals </span>
<span class="sd">        present in the ambient `profile` data, and if so, entrainment of </span>
<span class="sd">        these chemicals will change the concentrations computed for these </span>
<span class="sd">        tracers.  However, none of these concentrations are used in the </span>
<span class="sd">        dissolution of the dispersed phase.  Hence, `tracers` should not </span>
<span class="sd">        contain any chemicals present in the dispersed phase particles.</span>
<span class="sd">    p : `stratified_plume_model.ModelParams` object</span>
<span class="sd">        Object containing the fixed model parameters for the stratified </span>
<span class="sd">        plume model.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    t : float</span>
<span class="sd">        Initial time for the simulation (s)</span>
<span class="sd">    q : ndarray</span>
<span class="sd">        Initial value of the plume state space</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c"># Set the dimensions of the initial Lagrangian plume element</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">D</span> <span class="o">/</span> <span class="mf">5.</span>
    
    <span class="c"># Measure the arc length along the plume</span>
    <span class="n">s0</span> <span class="o">=</span> <span class="mf">0.</span>
    
    <span class="c"># Determine the volume flux of particles from the discharge</span>
    <span class="n">Qp</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)):</span>
        <span class="n">Qp</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nb0</span> <span class="o">/</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rho_p</span>
    
    <span class="c"># The total discharge volume flux is the jet discharge plus the particle</span>
    <span class="c"># flow rate</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">Qj</span> <span class="o">+</span> <span class="n">Qp</span>
    
    <span class="c"># Determine the time to fill the initial Lagrangian element</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">Q</span>
    
    <span class="c"># Compute the mass of jet discharge in the initial Lagrangian element</span>
    <span class="n">Mj</span> <span class="o">=</span> <span class="n">Qj</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">rho_j</span>
    
    <span class="c"># Get the actual number of particles following this Lagrangian element</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)):</span>
        <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nbe</span> <span class="o">=</span> <span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nb0</span> <span class="o">*</span> <span class="n">dt</span>
    
    <span class="c"># Get the velocity in the component directions</span>
    <span class="n">Uj</span> <span class="o">=</span> <span class="n">flux_to_velocity</span><span class="p">(</span><span class="n">Qj</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">phi_0</span><span class="p">,</span> <span class="n">theta_0</span><span class="p">)</span>
    
    <span class="c"># Compute the magnitude of the exit velocity </span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Uj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Uj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Uj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c"># Build the continuous-phase portion of the model state space vector</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">Mj</span><span class="p">,</span> <span class="n">Mj</span> <span class="o">*</span> <span class="n">Sj</span><span class="p">,</span> <span class="n">Mj</span> <span class="o">*</span> <span class="n">seawater</span><span class="o">.</span><span class="n">cp</span><span class="p">()</span> <span class="o">*</span> <span class="n">Tj</span><span class="p">,</span> <span class="n">Mj</span> <span class="o">*</span> <span class="n">Uj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Mj</span> <span class="o">*</span> <span class="n">Uj</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
          <span class="n">Mj</span> <span class="o">*</span> <span class="n">Uj</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">h</span> <span class="o">/</span> <span class="n">V</span><span class="p">,</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">s0</span><span class="p">]</span>
    
    <span class="c"># Add in the dispersed phase variables, one particle at a time</span>
    <span class="n">q</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dispersed_phases</span><span class="o">.</span><span class="n">particles_state_space</span><span class="p">(</span><span class="n">particles</span><span class="p">))</span>
    
    <span class="c"># Add the ambient concentrations of the dispersed-phase chemicals</span>
    <span class="n">ca</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">chem_names</span><span class="p">)</span>
    <span class="n">q</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Mj</span><span class="o">*</span><span class="n">ca</span><span class="p">)</span>
    
    <span class="c"># Add in the tracers discharged with the jet</span>
    <span class="n">q</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Mj</span><span class="o">*</span><span class="n">cj</span><span class="p">)</span>
    
    <span class="c"># Return the complete initial conditions</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="zfe_volume_flux"><a class="viewcode-back" href="../bpm/lmp.zfe_volume_flux.html#lmp.zfe_volume_flux">[docs]</a><span class="k">def</span> <span class="nf">zfe_volume_flux</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">X0</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Vj</span><span class="p">,</span> <span class="n">Sj</span><span class="p">,</span> <span class="n">Tj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the volume flux of continous phase discharge fluid at the release</span>
<span class="sd">    </span>
<span class="sd">    If the release includes continous phase fluid, this function computes</span>
<span class="sd">    the flow rate and geometry of the release</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile : `ambient.Profile` object</span>
<span class="sd">        The ambient CTD object used by the single bubble model simulation.</span>
<span class="sd">    X0 : ndarray</span>
<span class="sd">        Release location (x, y, z) in (m)</span>
<span class="sd">    R : float</span>
<span class="sd">        Radius for the equivalent circular cross-section of the release </span>
<span class="sd">        (m)</span>
<span class="sd">    Vj : float</span>
<span class="sd">        Scalar value of the magnitude of the discharge velocity for </span>
<span class="sd">        continuous phase fluid in the discharge.  This variable should be </span>
<span class="sd">        0 or None for a pure multiphase discharge.</span>
<span class="sd">    Sj : float</span>
<span class="sd">        Salinity of the continuous phase fluid in the discharge (psu)</span>
<span class="sd">    Tj : float</span>
<span class="sd">        Temperature of the continuous phase fluid in the discharge (T)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Q : Volume flux of continuous phase fluid at the discharge (m^3/s)</span>
<span class="sd">    A : Cross-sectional area of the discharge (M^2)</span>
<span class="sd">    X : ndarray</span>
<span class="sd">        Release location (x, y, z) in (m)</span>
<span class="sd">    Tj : float</span>
<span class="sd">        Temperature of the continuous phase fluid in the discharge (T)</span>
<span class="sd">    Sj : float</span>
<span class="sd">        Salinity of the continuous phase fluid in the discharge (psu)</span>
<span class="sd">    Pj : float</span>
<span class="sd">        Pressure at the discharge (Pa)</span>
<span class="sd">    rho_j : float</span>
<span class="sd">        Density of the continous phase fluid in the discharge (kg/m^3)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># The Lagrangian plume model starts at the discharge.</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X0</span>
    
    <span class="c"># Get the jet density from the discharge characteristics</span>
    <span class="n">Ta</span><span class="p">,</span> <span class="n">Sa</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;temperature&#39;</span><span class="p">,</span> <span class="s">&#39;salinity&#39;</span><span class="p">,</span> 
        <span class="s">&#39;pressure&#39;</span><span class="p">])</span>
    <span class="n">rho_j</span> <span class="o">=</span> <span class="n">seawater</span><span class="o">.</span><span class="n">density</span><span class="p">(</span><span class="n">Ta</span><span class="p">,</span> <span class="n">Sa</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
    
    <span class="c"># Pressure at the discharge is the ambient pressure</span>
    <span class="n">Pj</span> <span class="o">=</span> <span class="n">P</span>
    
    <span class="c"># The discharge area if the full port area</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">R</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="c"># Compute the volume flux of discharge fluid</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="n">Vj</span>
    
    <span class="c"># Return the initial conditions with salinity and temperature of the </span>
    <span class="c"># discharge equal to the jet values</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Tj</span><span class="p">,</span> <span class="n">Sj</span><span class="p">,</span> <span class="n">Pj</span><span class="p">,</span> <span class="n">rho_j</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="flux_to_velocity"><a class="viewcode-back" href="../bpm/lmp.flux_to_velocity.html#lmp.flux_to_velocity">[docs]</a><span class="k">def</span> <span class="nf">flux_to_velocity</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert fluid flow rate to three-component velocity </span>
<span class="sd">    </span>
<span class="sd">    Computes the three-component velocity (u, v, w) along the Cartesian </span>
<span class="sd">    directions (x, y, depth) from the flow rate, cross-sectional area, and the</span>
<span class="sd">    orientation (phi and theta).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Q : Volume flux of continuous phase fluid at the discharge (m^3/s)</span>
<span class="sd">    A : Cross-sectional area of the discharge (M^2)</span>
<span class="sd">    phi : float</span>
<span class="sd">        Vertical angle from the horizontal for the discharge orientation </span>
<span class="sd">        (rad in range +/- pi/2)</span>
<span class="sd">    theta : float</span>
<span class="sd">        Horizontal angle from the x-axis for the discharge orientation.  </span>
<span class="sd">        The x-axis is taken in the direction of the ambient current.  </span>
<span class="sd">        (rad in range 0 to 2 pi)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Uj : ndarray</span>
<span class="sd">        Vector of the three-component velocity of continous phase fluid in </span>
<span class="sd">        the jet (u, v, w) in the Cartesian direction (x, y, depth) </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Get the velocity along the jet centerline</span>
    <span class="n">Vj</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">/</span> <span class="n">A</span>
    
    <span class="c"># Project jet velocity on the three component directions (i, j, k)</span>
    <span class="n">Uj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">Uj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">Vj</span>
    <span class="n">Uj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">Vj</span>
    <span class="n">Uj</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">Vj</span>
    
    <span class="c"># Return the velocity vector</span>
    <span class="k">return</span> <span class="n">Uj</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../contents.html">
              <img class="logo" src="../_static/logo_holder.png" alt="Logo"/>
            </a></p>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Scott A. Socolofsky.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.3</a>
      
    </div>

    

    
  </body>
</html>